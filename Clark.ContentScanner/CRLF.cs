using Clark.Common.Models;
using Clark.Common.Utility;
using Clark.ContentScanner.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Clark.ContentScanner
{
    public static class CRLF
    {
        private static List<string> _payloads = new List<string>();
        private static readonly object _syncObject = new object();

        public static ScannerResult Check(ScannerRequest request)
        {
            if (_payloads.Count == 0)
            {
                lock (_syncObject)
                {
                    if (_payloads.Count == 0)
                        Initialize();
                }
            }


            ScannerResult result = new ScannerResult();

            foreach (string payload in _payloads)
            {
                string testUrl = request.URL.Trim('/') + "/" + payload;
                WebPageRequest webRequest = new WebPageRequest(testUrl);
                WebPageLoader.Load(webRequest);
                if(webRequest.Response.Headers.AllKeys.Contains("headername"))
                {
                    result.Success = true;
                    result.Results.Add(testUrl);
                    return result;
                }
            }

            return result;
        }

        private static void Initialize()
        {
            _payloads.Add("%0d%0a%09headername:%20headervalue");
            _payloads.Add("%0aheadername:%20headervalue");
            _payloads.Add("%3f%0dheadername:%20headervalue");
            _payloads.Add("%0d%0aheadername:%20headervalue");
            _payloads.Add("%0dheadername:%20headervalue");
            _payloads.Add("%23%0dheadername:%20headervalue");
            _payloads.Add("%3f%0d%0aheadername:%20headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8Dheadername:%20headervalue");
            _payloads.Add("?t=+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++headername:%20headervalue");
            _payloads.Add("%0Aheadername:headervalue");
            _payloads.Add("%0A%20headername:headervalue");
            _payloads.Add("%20%0Aheadername:headervalue");
            _payloads.Add("%23%OAheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8D%0Aheadername:headervalue");
            _payloads.Add("%3F%0Aheadername:headervalue");
            _payloads.Add("crlf%0Aheadername:headervalue");
            _payloads.Add("crlf%0A%20headername:headervalue");
            _payloads.Add("crlf%20%0Aheadername:headervalue");
            _payloads.Add("crlf%23%OAheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8D%0Aheadername:headervalue");
            _payloads.Add("crlf%3F%0Aheadername:headervalue");
            _payloads.Add("%0Dheadername:headervalue");
            _payloads.Add("%0D%20headername:headervalue");
            _payloads.Add("%20%0Dheadername:headervalue");
            _payloads.Add("%23%0Dheadername:headervalue");
            _payloads.Add("%23%0Aheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8D%0Dheadername:headervalue");
            _payloads.Add("%3F%0Dheadername:headervalue");
            _payloads.Add("crlf%0Dheadername:headervalue");
            _payloads.Add("crlf%0D%20headername:headervalue");
            _payloads.Add("crlf%20%0Dheadername:headervalue");
            _payloads.Add("crlf%23%0Dheadername:headervalue");
            _payloads.Add("crlf%23%0Aheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8D%0Dheadername:headervalue");
            _payloads.Add("crlf%3F%0Dheadername:headervalue");
            _payloads.Add("%0D%0Aheadername:headervalue");
            _payloads.Add("%0D%0A%20headername:headervalue");
            _payloads.Add("%20%0D%0Aheadername:headervalue");
            _payloads.Add("%23%0D%0Aheadername:headervalue");
            _payloads.Add("\r\nheadername:headervalue");
            _payloads.Add("%5cr%5cnheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue");
            _payloads.Add("%3F%0D%0Aheadername:headervalue");
            _payloads.Add("crlf%0D%0Aheadername:headervalue");
            _payloads.Add("crlf%0D%0A%20headername:headervalue");
            _payloads.Add("crlf%20%0D%0Aheadername:headervalue");
            _payloads.Add("crlf%23%0D%0Aheadername:headervalue");
            _payloads.Add("crlf\r\nheadername:headervalue");
            _payloads.Add("crlf%5cr%5cnheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8Dheadername:headervalue");
            _payloads.Add("crlf%E5%98%8A%E5%98%8D%0D%0Aheadername:headervalue");
            _payloads.Add("crlf%3F%0D%0Aheadername:headervalue");
            _payloads.Add("%0D%0A%09headername:headervalue");
            _payloads.Add("crlf%0D%0A%09headername:headervalue");
            _payloads.Add("%250Aheadername:headervalue");
            _payloads.Add("%25250Aheadername:headervalue");
            _payloads.Add("%%0A0Aheadername:headervalue");
            _payloads.Add("%25%30Aheadername:headervalue");
            _payloads.Add("%25%30%61headername:headervalue");
            _payloads.Add("%u000Aheadername:headervalue");
            _payloads.Add("//www.google.com/%2F%2E%2E%0D%0Aheadername:headervalue");
            _payloads.Add("/www.google.com/%2E%2E%2F%0D%0Aheadername:headervalue");
            _payloads.Add("/google.com/%2F..%0D%0Aheadername:headervalue");
        }
    }
}